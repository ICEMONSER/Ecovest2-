<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>EcoVest+ - Real-Time Feed (Firebase Demo)</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      border-radius: 12px;
      padding: 30px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
    }
    h1 {
      color: #333;
      margin-bottom: 10px;
      font-size: 2rem;
    }
    .subtitle {
      color: #666;
      margin-bottom: 30px;
      font-size: 0.9rem;
    }
    .post-box {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 30px;
      border: 2px solid #e9ecef;
    }
    .input-group {
      margin-bottom: 15px;
    }
    label {
      display: block;
      margin-bottom: 5px;
      color: #333;
      font-weight: 500;
    }
    input[type="text"],
    textarea {
      width: 100%;
      padding: 12px;
      border: 2px solid #dee2e6;
      border-radius: 6px;
      font-size: 1rem;
      font-family: inherit;
      transition: border-color 0.3s;
    }
    input[type="text"]:focus,
    textarea:focus {
      outline: none;
      border-color: #667eea;
    }
    textarea {
      resize: vertical;
      min-height: 100px;
    }
    button {
      background: #667eea;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 6px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.3s;
    }
    button:hover:not(:disabled) {
      background: #5568d3;
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    #feed {
      margin-top: 30px;
    }
    .post-item {
      background: white;
      border: 1px solid #e9ecef;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 15px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    .post-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    .post-author {
      font-weight: 600;
      color: #667eea;
    }
    .post-time {
      color: #999;
      font-size: 0.85rem;
    }
    .post-content {
      color: #333;
      line-height: 1.6;
      margin-bottom: 10px;
    }
    .delete-btn {
      background: #dc3545;
      padding: 6px 12px;
      font-size: 0.85rem;
      margin-top: 10px;
    }
    .delete-btn:hover:not(:disabled) {
      background: #c82333;
    }
    .empty-state {
      text-align: center;
      color: #999;
      padding: 40px;
      font-style: italic;
    }
    .status {
      padding: 10px;
      border-radius: 6px;
      margin-bottom: 20px;
      font-size: 0.9rem;
    }
    .status.connected {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .status.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    .status.loading {
      background: #fff3cd;
      color: #856404;
      border: 1px solid #ffeaa7;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üåê EcoVest+ Real-Time Feed</h1>
    <p class="subtitle">Posts sync across ALL devices instantly via Firebase Realtime Database</p>
    
    <!-- Connection Status -->
    <div id="status" class="status loading">üîÑ Connecting to Firebase...</div>
    
    <!-- Post Input Box -->
    <div class="post-box">
      <div class="input-group">
        <label for="nameInput">Your Name:</label>
        <input 
          type="text" 
          id="nameInput" 
          placeholder="Enter your name (default: Anonymous)"
          value="Anonymous"
        >
      </div>
      <div class="input-group">
        <label for="postInput">Write a Post:</label>
        <textarea 
          id="postInput" 
          placeholder="What's on your mind?"
          rows="4"
        ></textarea>
      </div>
      <button id="postBtn">üìù Post</button>
    </div>
    
    <!-- Feed Container -->
    <div id="feed">
      <div class="empty-state">Loading posts...</div>
    </div>
  </div>

  <!-- 
    ===================================================================
    FIREBASE REALTIME DATABASE - MINIMAL WORKING EXAMPLE
    ===================================================================
    
    DIAGNOSIS OF ORIGINAL ISSUES:
    ---------------------------------
    1. ‚ùå PROBLEM: Using Firebase compat SDK instead of modular v10
       - Was: firebase-app-compat.js (old style)
       - Fix: Use modular imports from gstatic v10
    
    2. ‚ùå PROBLEM: Fallback to localStorage in api.js (line 143-159)
       - Was: store.posts.add(post) saves to localStorage (local only)
       - Fix: Always use Firebase, no localStorage fallback
    
    3. ‚ùå PROBLEM: Using Date.now() instead of serverTimestamp()
       - Was: createdAt: Date.now() (client time, can be wrong)
       - Fix: Use serverTimestamp() for accurate server time
    
    4. ‚ùå PROBLEM: Firebase might not initialize if config is wrong
       - Was: Silent fallback to localStorage
       - Fix: Clear error messages and status indicators
    
    5. ‚ùå PROBLEM: No real-time listener on initial load
       - Was: Only loads once, doesn't update automatically
       - Fix: onValue() listener fires immediately and on every change
    
    HOW TO VERIFY IT'S WORKING:
    ---------------------------------
    1. Open browser DevTools (F12) ‚Üí Console tab
       - Should see: "‚úÖ Firebase initialized successfully"
       - Should see: "üîÑ Setting up real-time listener..."
       - Should see: "üì• Loaded X posts from Firebase"
    
    2. Open DevTools ‚Üí Network tab
       - Filter by "firebaseio.com" or "firebasedatabase.app"
       - When you post, should see POST request with 200 status
       - Should see WebSocket connection for real-time updates
    
    3. Test on two devices:
       - Device A: Create a post
       - Device B: Post should appear within 1-2 seconds (no refresh!)
    
    4. Check Firebase Console:
       - Go to: https://console.firebase.google.com/
       - Select project: ecovest-37a65
       - Realtime Database ‚Üí Data tab
       - Should see "posts" folder with your posts
    
    FIREBASE DATABASE RULES (REQUIRED):
    ---------------------------------
    Go to Firebase Console ‚Üí Realtime Database ‚Üí Rules tab
    Paste this (for demo - open read/write):
    
    {
      "rules": {
        ".read": true,
        ".write": true
      }
    }
    
    Click "Publish" - this allows anyone to read/write (for demo only)
    
    For production, use:
    {
      "rules": {
        "posts": {
          ".read": true,
          ".write": true
        }
      }
    }
    
    COMMON ERRORS TO CHECK:
    ---------------------------------
    1. "Firebase not initialized" ‚Üí Check firebaseConfig values
    2. "Permission denied" ‚Üí Check Database Rules are published
    3. "Network error" ‚Üí Check databaseURL is correct (https://)
    4. "CORS error" ‚Üí Shouldn't happen with Firebase, but check Network tab
    5. Posts not appearing ‚Üí Check Rules allow .read: true
    6. Can't post ‚Üí Check Rules allow .write: true
    
    ===================================================================
  -->
  
  <script type="module">
    // ===================================================================
    // FIREBASE v10 MODULAR IMPORTS (Required for GitHub Pages)
    // ===================================================================
    // Using CDN imports from gstatic - works on GitHub Pages
    // No build step needed, works directly in browser
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
    import { 
      getDatabase, 
      ref, 
      push, 
      onValue, 
      remove,
      serverTimestamp 
    } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-database.js";

    // ===================================================================
    // FIREBASE CONFIGURATION
    // ===================================================================
    // TODO: Replace with your actual Firebase config from Firebase Console
    // Steps to get config:
    // 1. Go to https://console.firebase.google.com/
    // 2. Select your project (or create new one)
    // 3. Click gear icon ‚öôÔ∏è ‚Üí Project settings
    // 4. Scroll to "Your apps" ‚Üí Web icon </>
    // 5. Copy the config object values below
    
    const firebaseConfig = {
      apiKey: "AIzaSyD3v99P_uq3cIMIUUKroFr_qbcLsbY-i3Q",
      authDomain: "ecovest-37a65.firebaseapp.com",
      // ‚ö†Ô∏è CRITICAL: databaseURL must match EXACTLY from Firebase Console
      // Must be https:// and end with .firebasedatabase.app or .firebaseio.com
      // NO trailing slash!
      databaseURL: "https://ecovest-37a65-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "ecovest-37a65",
      storageBucket: "ecovest-37a65.firebasestorage.app",
      messagingSenderId: "63854480161",
      appId: "1:63854480161:web:bf94c2bbd0c5b4c4650c60"
    };

    // ===================================================================
    // INITIALIZE FIREBASE
    // ===================================================================
    let app, database;
    
    try {
      console.log('üîÑ Initializing Firebase...');
      app = initializeApp(firebaseConfig);
      database = getDatabase(app);
      console.log('‚úÖ Firebase initialized successfully');
      console.log('üìä Database URL:', firebaseConfig.databaseURL);
      
      // Update status
      updateStatus('connected', '‚úÖ Connected to Firebase - Ready to post!');
    } catch (error) {
      console.error('‚ùå Firebase initialization error:', error);
      updateStatus('error', `‚ùå Firebase Error: ${error.message}`);
      throw error;
    }

    // ===================================================================
    // DOM ELEMENTS
    // ===================================================================
    const nameInput = document.getElementById('nameInput');
    const postInput = document.getElementById('postInput');
    const postBtn = document.getElementById('postBtn');
    const feed = document.getElementById('feed');
    const statusEl = document.getElementById('status');

    // ===================================================================
    // STATUS INDICATOR
    // ===================================================================
    function updateStatus(type, message) {
      statusEl.className = `status ${type}`;
      statusEl.textContent = message;
    }

    // ===================================================================
    // CREATE POST - Saves to Firebase (visible on ALL devices)
    // ===================================================================
    async function createPost() {
      const name = nameInput.value.trim() || 'Anonymous';
      const text = postInput.value.trim();
      
      // Validate input
      if (!text) {
        alert('Please write something!');
        return;
      }

      // Prevent double-posting
      postBtn.disabled = true;
      postBtn.textContent = 'Posting...';

      try {
        console.log('üíæ Creating post...', { name, text });
        
        // Get reference to posts collection
        const postsRef = ref(database, 'posts');
        
        // Push new post with serverTimestamp() for accurate time
        // This is the KEY FIX: Using serverTimestamp() instead of Date.now()
        const newPostRef = await push(postsRef, {
          name: name,
          text: text,
          // ‚úÖ FIX: Use serverTimestamp() for accurate server time
          // This ensures posts are sorted correctly across all devices
          time: serverTimestamp()
        });

        console.log('‚úÖ Post created successfully! ID:', newPostRef.key);
        console.log('üì° Post will appear on all devices within 1-2 seconds');
        
        // Clear input
        postInput.value = '';
        
        // Show success feedback
        updateStatus('connected', '‚úÖ Post created! Visible on all devices now.');
        setTimeout(() => {
          updateStatus('connected', '‚úÖ Connected to Firebase - Ready to post!');
        }, 2000);
        
      } catch (error) {
        console.error('‚ùå Error creating post:', error);
        updateStatus('error', `‚ùå Failed to create post: ${error.message}`);
        alert('Failed to create post. Check console for details.');
      } finally {
        postBtn.disabled = false;
        postBtn.textContent = 'üìù Post';
      }
    }

    // ===================================================================
    // DELETE POST (only your own posts)
    // ===================================================================
    async function deletePost(postId, postName) {
      const currentName = nameInput.value.trim() || 'Anonymous';
      
      // Check if it's your post
      if (postName !== currentName) {
        alert('You can only delete your own posts!');
        return;
      }

      if (!confirm('Are you sure you want to delete this post?')) {
        return;
      }

      try {
        console.log('üóëÔ∏è Deleting post...', postId);
        const postRef = ref(database, `posts/${postId}`);
        await remove(postRef);
        console.log('‚úÖ Post deleted successfully!');
      } catch (error) {
        console.error('‚ùå Error deleting post:', error);
        alert('Failed to delete post. Check console for details.');
      }
    }

    // ===================================================================
    // RENDER POSTS - Displays all posts from Firebase
    // ===================================================================
    function renderPosts(posts) {
      if (posts.length === 0) {
        feed.innerHTML = '<div class="empty-state">No posts yet. Be the first to post! üéâ</div>';
        return;
      }

      // Sort by time (newest first) - serverTimestamp ensures correct order
      // ‚úÖ FIX: Sort by serverTimestamp (time field) descending
      const sortedPosts = posts.sort((a, b) => {
        // Handle serverTimestamp placeholder (it's an object before server processes it)
        const timeA = a.time && typeof a.time === 'object' ? Date.now() : (a.time || 0);
        const timeB = b.time && typeof b.time === 'object' ? Date.now() : (b.time || 0);
        return timeB - timeA; // Newest first
      });

      const currentName = nameInput.value.trim() || 'Anonymous';

      feed.innerHTML = sortedPosts.map(post => {
        const isOwnPost = post.name === currentName;
        const deleteButton = isOwnPost 
          ? `<button class="delete-btn" onclick="window.deletePost('${post.id}', '${post.name}')">Delete</button>`
          : '';

        // Format time
        const time = post.time && typeof post.time === 'object' 
          ? 'just now' 
          : formatTimeAgo(post.time || Date.now());

        return `
          <div class="post-item">
            <div class="post-header">
              <span class="post-author">${escapeHtml(post.name)}</span>
              <span class="post-time">${time}</span>
            </div>
            <div class="post-content">${escapeHtml(post.text)}</div>
            ${deleteButton}
          </div>
        `;
      }).join('');
    }

    // ===================================================================
    // FORMAT TIME AGO
    // ===================================================================
    function formatTimeAgo(timestamp) {
      const now = Date.now();
      const diff = now - timestamp;
      const minutes = Math.floor(diff / 60000);
      const hours = Math.floor(diff / 3600000);
      const days = Math.floor(diff / 86400000);

      if (minutes < 1) return 'just now';
      if (minutes < 60) return `${minutes}m ago`;
      if (hours < 24) return `${hours}h ago`;
      return `${days}d ago`;
    }

    // ===================================================================
    // ESCAPE HTML (Security)
    // ===================================================================
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // ===================================================================
    // SET UP REAL-TIME LISTENER
    // ===================================================================
    // ‚úÖ KEY FIX: This is what makes posts sync across ALL devices
    // onValue() fires immediately with current data, then on every change
    function setupRealtimeListener() {
      console.log('üîÑ Setting up real-time listener for posts...');
      const postsRef = ref(database, 'posts');
      
      // Listen for changes - fires immediately and on every update
      onValue(postsRef, (snapshot) => {
        const posts = [];
        
        if (snapshot.exists()) {
          snapshot.forEach((child) => {
            posts.push({
              id: child.key,
              ...child.val()
            });
          });
        }
        
        console.log(`üì• Real-time update: ${posts.length} posts loaded`);
        console.log('üîÑ Feed will update automatically on all devices!');
        
        renderPosts(posts);
        updateStatus('connected', `‚úÖ Connected - ${posts.length} posts loaded`);
      }, (error) => {
        console.error('‚ùå Real-time listener error:', error);
        updateStatus('error', `‚ùå Connection error: ${error.message}`);
        feed.innerHTML = '<div class="empty-state">Error loading posts. Please refresh the page.</div>';
      });
    }

    // ===================================================================
    // EVENT LISTENERS
    // ===================================================================
    postBtn.addEventListener('click', createPost);
    
    postInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter' && e.ctrlKey) {
        createPost();
      }
    });

    // Make deletePost available globally (for onclick handlers)
    window.deletePost = deletePost;

    // ===================================================================
    // INITIALIZE - Set up real-time listener when page loads
    // ===================================================================
    console.log('üöÄ Initializing feed...');
    setupRealtimeListener();
    console.log('‚úÖ Real-time listener active - posts will sync across all devices!');
  </script>
</body>
</html>

